<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisor de Cuentas</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #upload-section, #analysis-section, #people-section, #checklists-section, #results-section { margin-bottom: 20px; }
        button { padding: 10px; margin-top: 10px; }
        .person-checklist { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Divisor de Cuentas para Comidas en Grupo</h1>

    <div id="upload-section">
        <h2>Paso 1: Sube la imagen del ticket</h2>
        <input type="file" id="ticket-image" accept="image/*">
        <button onclick="analyzeTicket()">Analizar Ticket</button>
    </div>

    <div id="analysis-section" style="display: none;">
        <h2>Productos Analizados</h2>
        <ul id="items-list"></ul>
        <button onclick="proceedToPeople()">Continuar</button>
    </div>

    <div id="people-section" style="display: none;">
        <h2>Paso 2: ¿Cuántas personas han comido?</h2>
        <input type="number" id="num-people" min="1" value="2">
        <button onclick="generateChecklists()">Generar Checklists</button>
    </div>

    <div id="checklists-section" style="display: none;">
        <h2>Paso 3: Selecciona los productos para cada persona</h2>
        <div id="checklists"></div>
        <button onclick="calculatePayments()">Calcular Pagos</button>
    </div>

    <div id="results-section" style="display: none;">
        <h2>Resultados</h2>
        <ul id="payments-list"></ul>
    </div>

    <script>
        let items = []; // Array de {name: string, price: number}

        async function analyzeTicket() {
            const fileInput = document.getElementById('ticket-image');
            if (!fileInput.files.length) {
                alert('Por favor, sube una imagen del ticket.');
                return;
            }

            const image = fileInput.files[0];
            const worker = await Tesseract.createWorker('eng+spa'); // Soporte para inglés y español
            const { data: { text } } = await worker.recognize(image);
            await worker.terminate();

            // Parsear el texto del ticket (simplificado: asume líneas como "Item - $10.00" o similar)
            const lines = text.split('\n').filter(line => line.trim());
            items = [];
            lines.forEach(line => {
                const match = line.match(/(.+?)\s+[\d.,]+\s*(\d+\.?\d*)/); // Busca nombre y precio al final
                if (match) {
                    const name = match[1].trim();
                    const price = parseFloat(match[2].replace(',', '.'));
                    if (!isNaN(price)) {
                        items.push({ name, price });
                    }
                }
            });

            if (items.length === 0) {
                alert('No se pudieron extraer productos del ticket. Intenta con una imagen más clara.');
                return;
            }

            // Mostrar items
            const list = document.getElementById('items-list');
            list.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name}: ${item.price.toFixed(2)} €`;
                list.appendChild(li);
            });

            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('analysis-section').style.display = 'block';
        }

        function proceedToPeople() {
            document.getElementById('analysis-section').style.display = 'none';
            document.getElementById('people-section').style.display = 'block';
        }

        function generateChecklists() {
            const numPeople = parseInt(document.getElementById('num-people').value);
            if (isNaN(numPeople) || numPeople < 1) {
                alert('Ingresa un número válido de personas.');
                return;
            }

            const checklistsDiv = document.getElementById('checklists');
            checklistsDiv.innerHTML = '';

            for (let i = 1; i <= numPeople; i++) {
                const personDiv = document.createElement('div');
                personDiv.className = 'person-checklist';
                personDiv.innerHTML = `<h3>Persona ${i}</h3>`;

                items.forEach((item, index) => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.person = i;
                    checkbox.dataset.item = index;
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(` ${item.name} (${item.price.toFixed(2)} €)`));
                    personDiv.appendChild(label);
                    personDiv.appendChild(document.createElement('br'));
                });

                checklistsDiv.appendChild(personDiv);
            }

            document.getElementById('people-section').style.display = 'none';
            document.getElementById('checklists-section').style.display = 'block';
        }

        function calculatePayments() {
            const numPeople = document.querySelectorAll('.person-checklist').length;
            const payments = Array(numPeople).fill(0);

            // Mapa de cuántas personas reclamaron cada item
            const itemClaims = items.map(() => 0);

            // Contar claims
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                const person = parseInt(checkbox.dataset.person) - 1;
                const itemIndex = parseInt(checkbox.dataset.item);
                itemClaims[itemIndex]++;
            });

            // Calcular pagos
            items.forEach((item, index) => {
                if (itemClaims[index] > 0) {
                    const share = item.price / itemClaims[index];
                    document.querySelectorAll(`input[data-item="${index}"]:checked`).forEach(checkbox => {
                        const person = parseInt(checkbox.dataset.person) - 1;
                        payments[person] += share;
                    });
                }
            });

            // Verificar si todos los items fueron reclamados
            const unclaimed = itemClaims.filter(count => count === 0).length;
            if (unclaimed > 0) {
                alert(`${unclaimed} productos no fueron reclamados por nadie. Asegúrate de distribuir todos.`);
                return;
            }

            // Mostrar resultados
            const list = document.getElementById('payments-list');
            list.innerHTML = '';
            payments.forEach((amount, index) => {
                const li = document.createElement('li');
                li.textContent = `Persona ${index + 1}: ${amount.toFixed(2)} €`;
                list.appendChild(li);
            });

            document.getElementById('checklists-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';
        }
    </script>
</body>
</html>
