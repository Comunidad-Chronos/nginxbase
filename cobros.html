<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisor de Cuentas</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script> <!-- Fallback si API falla -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .app-container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .step-header { text-align: center; margin-bottom: 20px; }
        .item-list { list-style: none; padding: 0; }
        .item-list li { background: #e9ecef; margin: 5px 0; padding: 10px; border-radius: 5px; }
        .person-checklist { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .person-checklist label { display: block; margin-bottom: 5px; }
        .results-list li { font-size: 1.2em; font-weight: bold; color: #198754; }
        .loading { text-align: center; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState } = React;

        function App() {
            const [step, setStep] = useState(1);
            const [imageFile, setImageFile] = useState(null);
            const [items, setItems] = useState([]);
            const [numPeople, setNumPeople] = useState(2);
            const [assignments, setAssignments] = useState({});
            const [payments, setPayments] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const encodedKey = 'eGFpLXZWeldPZlBwcW95STY4S3BuZWkxbkdKVVJlZWVyQzhWWU0wSzVWWm52aWtxS1ZvQ3ZBS1o0MEhzMEdkMDN3eE52V0lDTDBSRDlnQjlRWkI3';
            const API_ENDPOINT = 'https://api.x.ai/v1/chat/completions';
            const MODEL = 'grok-4';

            const handleImageChange = (e) => {
                setImageFile(e.target.files[0]);
            };

            const analyzeWithAPI = async (base64Image) => {
                const apiKey = atob(encodedKey);
                const prompt = `Analiza esta imagen de ticket de compra. Extrae SOLO la sección de productos: para cada línea, identifica cantidad (si >1, divide en ítems individuales con precio unitario), nombre del producto y precio unitario. Ignora encabezados, totales, IVA, pagos y notas. Tu respuesta debe ser SOLO un objeto JSON válido, sin texto adicional, sin bloques de código, sin explicaciones: { "items": [{ "name": "Producto", "price": 1.23 }, ...] }. Ejemplo: Si "2x Cerveza 5.00" (total 5.00), divide en dos { "name": "Cerveza", "price": 2.50 }.`;

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: [
                            { role: 'user', content: [{ type: 'text', text: prompt }, { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64Image}` } }] }
                        ],
                        max_tokens: 1000,
                        temperature: 0.1 // Bajado para más determinismo
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error en API: ${response.statusText} - Verifica tu clave y suscripción en https://x.ai/api.`);
                }

                const data = await response.json();
                let content = data.choices[0].message.content;
                // Limpia posibles bloques de código o texto extra
                content = content.replace(/```json|```/g, '').replace(/`/g, '').trim();

                let parsedItems;
                try {
                    parsedItems = JSON.parse(content).items || [];
                } catch (err) {
                    throw new Error('Respuesta no es JSON válido después de limpieza: ' + content);
                }

                if (parsedItems.length === 0) {
                    throw new Error('No se extrajeron items de la respuesta.');
                }
                return parsedItems;
            };

            const analyzeTicket = async () => {
                if (!imageFile) {
                    alert('Sube una imagen del ticket.');
                    return;
                }

                setIsLoading(true);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result.split(',')[1];
                    try {
                        const parsedItems = await analyzeWithAPI(base64);
                        setItems(parsedItems);
                        setStep(2);
                    } catch (error) {
                        console.error('Error detallado:', error);
                        console.log('Respuesta cruda de API:', error.message);
                        alert('Error al analizar con API: ' + error.message + '. Abre la consola del navegador (presiona F12 o Cmd+Option+J en Mac) para ver más detalles. Usando fallback Tesseract como alternativa...');
                        await fallbackTesseract();
                    } finally {
                        setIsLoading(false);
                    }
                };
                reader.readAsDataURL(imageFile);
            };

            const fallbackTesseract = async () => {
                const worker = await Tesseract.createWorker('eng+spa');
                const { data: { text } } = await worker.recognize(imageFile);
                await worker.terminate();

                const skipWords = ['total', 'subtotal', 'iva', 'tax', 'propina', 'gracias', 'efectivo', 'cambio'];
                const lines = text.split('\n').filter(line => {
                    const trimmed = line.trim();
                    return trimmed && !skipWords.some(word => trimmed.toLowerCase().includes(word));
                });

                const parsedItems = [];
                lines.forEach(line => {
                    let qty = 1;
                    let name = '';
                    let price = 0;

                    const qtyMatch = line.match(/^\s*(\d+)\s*x?\s*(.+?)\s*(\d+[.,]?\d*)\s*$/);
                    if (qtyMatch) {
                        qty = parseInt(qtyMatch[1]);
                        name = qtyMatch[2].trim();
                        const totalPrice = parseFloat(qtyMatch[3].replace(',', '.'));
                        price = totalPrice / qty;
                    } else {
                        const noQtyMatch = line.match(/^\s*(.+?)\s*(\d+[.,]?\d*)\s*$/);
                        if (noQtyMatch) {
                            name = noQtyMatch[1].trim();
                            price = parseFloat(noQtyMatch[2].replace(',', '.'));
                        }
                    }

                    if (name && !isNaN(price)) {
                        for (let i = 0; i < qty; i++) {
                            parsedItems.push({ name, price });
                        }
                    }
                });

                if (parsedItems.length > 0) {
                    setItems(parsedItems);
                    setStep(2);
                } else {
                    alert('No se pudieron extraer productos ni con el fallback. Intenta con una imagen más clara o verifica el formato del ticket.');
                }
            };

            const proceedToPeople = () => {
                setStep(3);
            };

            const generateChecklists = () => {
                const newAssignments = {};
                for (let i = 1; i <= numPeople; i++) {
                    newAssignments[i] = Array(items.length).fill(false);
                }
                setAssignments(newAssignments);
                setStep(4);
            };

            const toggleCheckbox = (person, itemIndex) => {
                setAssignments(prev => ({
                    ...prev,
                    [person]: prev[person].map((checked, idx) => idx === itemIndex ? !checked : checked)
                }));
            };

            const calculatePayments = () => {
                const itemClaims = items.map(() => 0);
                Object.values(assignments).forEach(personChecks => {
                    personChecks.forEach((checked, idx) => {
                        if (checked) itemClaims[idx]++;
                    });
                });

                const unclaimed = itemClaims.filter(count => count === 0).length;
                if (unclaimed > 0) {
                    alert(`${unclaimed} productos no fueron asignados. Asegúrate de distribuir todos antes de calcular.`);
                    return;
                }

                const newPayments = Array(numPeople).fill(0);
                items.forEach((item, idx) => {
                    if (itemClaims[idx] > 0) {
                        const share = item.price / itemClaims[idx];
                        Object.keys(assignments).forEach(person => {
                            if (assignments[person][idx]) {
                                newPayments[parseInt(person) - 1] += share;
                            }
                        });
                    }
                });

                setPayments(newPayments);
                setStep(5);
            };

            return (
                <div className="app-container">
                    <h1 className="step-header">Divisor de Cuentas</h1>

                    {step === 1 && (
                        <div>
                            <h2 className="step-header">Paso 1: Sube el ticket</h2>
                            <input type="file" accept="image/*" onChange={handleImageChange} className="form-control mb-3" />
                            <button onClick={analyzeTicket} className="btn btn-primary w-100" disabled={isLoading}>
                                {isLoading ? 'Analizando...' : 'Analizar Ticket'}
                            </button>
                            {isLoading && <div className="loading"><div className="spinner-border text-primary" role="status"><span className="visually-hidden">Cargando...</span></div><p>Procesando la imagen, puede tomar unos segundos...</p></div>}
                            <p className="text-muted mt-2">Si ocurre un error, abre la consola del navegador (F12) para ver detalles y reportarlos. Asegúrate de que la imagen sea clara y el ticket esté bien enfocado.</p>
                        </div>
                    )}

                    {step === 2 && (
                        <div>
                            <h2 className="step-header">Productos Extraídos</h2>
                            <ul className="item-list">
                                {items.map((item, idx) => (
                                    <li key={idx}>{item.name}: {item.price.toFixed(2)} €</li>
                                ))}
                            </ul>
                            <button onClick={proceedToPeople} className="btn btn-primary w-100">Continuar</button>
                        </div>
                    )}

                    {step === 3 && (
                        <div>
                            <h2 className="step-header">Paso 2: ¿Cuántas personas?</h2>
                            <input type="number" min="1" value={numPeople} onChange={(e) => setNumPeople(parseInt(e.target.value))} className="form-control mb-3" />
                            <button onClick={generateChecklists} className="btn btn-primary w-100">Generar Checklists</button>
                        </div>
                    )}

                    {step === 4 && (
                        <div>
                            <h2 className="step-header">Paso 3: Asigna productos</h2>
                            {Array.from({ length: numPeople }).map((_, i) => {
                                const person = i + 1;
                                return (
                                    <div key={person} className="person-checklist">
                                        <h3>Persona {person}</h3>
                                        {items.map((item, idx) => (
                                            <label key={idx}>
                                                <input type="checkbox" checked={assignments[person]?.[idx] || false} onChange={() => toggleCheckbox(person, idx)} />
                                                {` ${item.name} (${item.price.toFixed(2)} €)`}
                                            </label>
                                        ))}
                                    </div>
                                );
                            })}
                            <button onClick={calculatePayments} className="btn btn-success w-100">Calcular</button>
                        </div>
                    )}

                    {step === 5 && (
                        <div>
                            <h2 className="step-header">Resultados</h2>
                            <ul className="results-list">
                                {payments.map((amount, idx) => (
                                    <li key={idx}>Persona {idx + 1}: {amount.toFixed(2)} €</li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
